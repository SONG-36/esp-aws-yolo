# ESP32-S3 模块详细设计

## 1 模块定位与职责

ESP32-S3 设备为边缘数据进口节点，主要职责包括：

- 接受相机数据，实时捕捉图像
- 培成为 Base64 格式并打包为 JSON 数据
- 通过 MQTT over TLS 将数据发送至 AWS IoT Core

## 2 面向对象分层架构设计

​	为提高系统的可维护性、可移植性与模块解耦能力，本项目采用 **面向对象的三层分层架构**，将嵌入式系统的业务逻辑、任务调度与底层硬件驱动有效隔离，形成清晰的责任边界。整体结构分为：

- **App 层（应用业务层）**
- **Middleware 层（中间件逻辑层）**
- **Driver 层（底层驱动层）**

​	并结合统一的任务注册机制与驱动接口抽象机制，形成灵活可扩展的系统基础

### 2.1 各层职责划分

| 层级          | 说明                                                         |
| ------------- | ------------------------------------------------------------ |
| App 层        | 实现上层业务逻辑，如图像采集、控制指令处理、云端通信等功能。每个功能模块对应一个 RTOS 任务，但**任务的创建由 Middleware 层完成**。 |
| Middleware 层 | 项目核心调度与桥接层，负责所有任务的注册、调度与生命周期管理，封装对底层 Driver 的统一接口，并承担多芯片平台的适配与兼容。 |
| Driver 层     | 负责硬件相关操作的具体实现，如摄像头驱动、串口通信、PWM 控制等。按芯片型号或功能模块进行分类组织，供 Middleware 层统一调用。 |

### 2.2 Middleware 层设计核心

#### 2.2.1 **任务初始化与调度核心**

（1）**主程序入口 main() 放置于 Middleware 层**：

- 在 ESP-IDF 中，`app_main()` 是启动入口，通常在 `main.c/.cpp` 中实现；

- 本项目遵循分层设计，因此 `main()` 位于 Middleware 层，主控所有初始化逻辑。

（2）**集中调度系统任务创建（xTaskCreate）**：

- 所有 RTOS 任务（包括 App 层任务）都不在其自身定义中执行创建；

- 中间件统一维护任务调度列表，并调用 `xTaskCreate()` 进行批量调度；

- 便于统一设置优先级、栈大小、调试 hook、内存检测等参数。

#### 2.2.2 驱动抽象与统一接口封装

（1）Driver层多芯片支持分目录结构

```txt
drivers/
└── esp32-s3/                  // 针对 ESP32-S3 芯片的所有驱动
    ├── ov2640/               // 摄像头驱动
    ├── esp_uart/             // UART 串口驱动
    ├── mqtt_client/          // MQTT 通信驱动
    ├── mcpwm/                // PWM 电机控制
    └── gpio_expander/        // GPIO 扩展器驱动（如有）
```

（2）Middleware

- 提供 `camera_hal_start()`, `uart_hal_send()`, `mqtt_hal_publish()` 等通用函数；

- 对 App 层隐藏底层芯片型号、寄存器操作、第三方库差异；

- 使得 App 层代码具备**可移植性与芯片解耦能力**。

#### 2.2.3 App → Middleware 的任务注册机制

- **App 层采用静态任务登记数组**：

```c
const task_config_t app_tasks[] = {
    { .name = "CameraTask", .entry = camera_task, .stack = 4096, .priority = 5 },
    { .name = "UploadTask", .entry = upload_task, .stack = 4096, .priority = 4 },
    // ... 可扩展更多任务配置
};
```

- **Middleware 层统一读取该数组并自动创建任务**：

  - 遍历 `app_tasks[]` 数组 → `xTaskCreate()`；

  - 自动注册 FreeRTOS 任务，并打印日志、检测栈溢出。

- **支持任务动态扩展与复用**：
  - 新增任务时 App 仅需在数组中新增配置项；
  - Middleware 层完全无需修改，符合“开放封闭原则”。

#### 2.2.4 配置集中化与管理模块

- **统一配置项集中管理**：

  - 栈大小、任务优先级、日志等级、缓冲区大小等统一放入 `system_config.h`；

  - 支持 `menuconfig` 调参或编译期宏控制（通过 `sdkconfig`）；

- **便于调试与维护**：

  - 集中化配置避免分散在多个模块；

  - 所有资源配置可在一处查看并统一调整；

  - 减少调试时修改多个文件的维护成本。

### 2.3 系统运行支持模块设计

#### 2.3.1 日志系统与调试机制

在嵌入式系统开发中，日志系统是调试与系统行为追踪的关键工具。本项目采用模块化的日志机制，并由 Middleware 层统一初始化与调度，实现以下目标：

- 支持多级别日志输出（ERROR / WARN / INFO / DEBUG）
- 可选择性启用串口或 USB 作为输出通道
- 日志输出风格统一，便于日志采集与分析
- 支持条件编译和运行时等级切换，提高运行效率

（1）日志等级定义

项目中定义四个等级：

| 等级宏定义  | 描述         | 默认是否启用 |
| ----------- | ------------ | ------------ |
| `LOG_ERROR` | 严重错误     | 启用         |
| `LOG_WARN`  | 警告信息     | 启用         |
| `LOG_INFO`  | 一般运行信息 | 启用         |
| `LOG_DEBUG` | 调试详细信息 | 默认关闭     |

（2）日志接口封装

统一使用如下接口输出日志：

```c
LOG_ERROR("Camera init failed: %d", err_code);
LOG_INFO("System started at %d ms", timestamp);
```

​	底层使用 `vprintf()` + `串口/USB输出` 实现，支持格式化输出。所有日志输出由 `middleware/log.c` 模块实现，并在系统初始化阶段注册串口通道。

（3）通道适配与输出控制

- 支持 `UART`、`USB CDC` 输出方式切换（通过 `#define LOG_USE_USB` 控制）

- 日志等级可通过编译宏或配置文件调整：

```c
#define LOG_LEVEL LOG_INFO
```

（4）日志初始化流程

日志初始化流程由 middleware 层统一调用：

```c
void middleware_init() {
    log_init();         // 初始化串口/USB，注册格式化函数
    driver_init_all();  // 初始化驱动
    task_create_all();  // 创建 RTOS 任务
}
```

​	该结构保证日志模块可在系统早期提供稳定输出，有助于排查启动失败等问题。

（5）日志调试方案设计

| 场景         | 推荐日志等级 | 原因说明               |
| ------------ | ------------ | ---------------------- |
| 正常运行     | LOG_INFO     | 保持运行轨迹清晰       |
| 性能调优阶段 | LOG_DEBUG    | 打印关键变量与事件时序 |
| 异常频繁排查 | LOG_ERROR    | 仅记录错误快速定位     |

#### 2.3.2 